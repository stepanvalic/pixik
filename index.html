<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Art Video Generator</title>
    <style>
        video, canvas {
            display: block;
            margin: 20px auto;
        }

        #palettePreview {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        #palettePreview div {
            width: 20px;
            height: 20px;
            margin: 0 5px 5px 0;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <input type="file" id="videoInput" accept="video/*">
    <label for="pixelSize">Pixel Size:</label>
    <input type="number" id="pixelSize" value="15" min="1">
    <label for="brightness">Brightness:</label>
    <input type="number" id="brightness" value="100" min="0" max="200">
    <label for="colorPalette">Color Palette:</label>
    <select id="colorPalette">
        <option value="basic">Basic</option>
        <option value="grayscale">Grayscale</option>
        <option value="nes">NES</option>
        <option value="c64">Commodore 64</option>
        <option value="gameboy">GameBoy</option>
        <option value="atari">Atari</option>
    </select>
    <button id="download">Download Pixel Art Video</button>
    <video id="video" controls></video>
    <canvas id="canvas"></canvas>
    <div id="palettePreview"></div>
    <script>
        const videoInput = document.getElementById('videoInput');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const pixelSizeInput = document.getElementById('pixelSize');
        const brightnessInput = document.getElementById('brightness');
        const colorPaletteInput = document.getElementById('colorPalette');
        const downloadButton = document.getElementById('download');
        const palettePreview = document.getElementById('palettePreview');
        let pixelSize = parseInt(pixelSizeInput.value, 10);
        let brightness = parseInt(brightnessInput.value, 10) / 100;
        let colorPalette = 'basic';

        const palettes = {
            basic: [[0,0,0], [255,255,255], [255,0,0], [0,255,0], [0,0,255], [255,255,0], [0,255,255], [255,0,255]],
            grayscale: [[0,0,0], [255,255,255], [128,128,128], [64,64,64], [192,192,192]],
            nes: [
                [0,0,0], [124,124,124], [188,188,188], [252,252,252], [252,0,0], [188,0,0], [124,0,0],
                [252,124,0], [188,124,0], [124,124,0], [252,252,0], [188,188,0], [124,188,0],
                [0,252,0], [0,188,0], [0,124,0], [0,252,124], [0,188,124], [0,124,124],
                [0,252,252], [0,188,252], [0,124,252], [124,124,252], [188,124,252], [252,124,252]
            ],
            c64: [
                [0,0,0], [255,255,255], [137,61,59], [133,149,165], [109,165,107], [113,136,198],
                [189,102,89], [85,80,61], [159,108,78], [116,139,162], [146,222,154], [137,182,240],
                [187,146,164], [136,123,94], [204,191,153], [173,206,183]
            ],
            gameboy: [
                [15,56,15], [48,98,48], [139,172,15], [155,188,15]
            ],
            // atari: [
            // [0,0,0], [162,162,162], [252,252,252], [252,116,96], [220,144,115], [144,116,128],
            // [116,96,80], [124,104,168], [168,64,68], [144,116,116], [104,144,116], [136,64,124],
            // [172,144,104], [140,96,124], [124,88,96], [132,112,108], [134,117,106]
            // ]
            atari: [
                [0,0,0], [162,162,162], [252,252,252], [220,144,115], [144,116,128],
                [116,96,80], [124,104,168], [144,116,116], [104,144,116], [172,144,104], 
                [140,96,124], [124,88,96], [132,112,108], [134,117,106],
                [/* Extrahované barvy z obrázku zde */]
                [89, 82, 93], [185, 183, 187], [220, 215, 208], [166, 150, 142], [123, 98, 91]
            ]
        };

        videoInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            const url = URL.createObjectURL(file);
            video.src = url;
        });

        pixelSizeInput.addEventListener('change', () => {
            pixelSize = parseInt(pixelSizeInput.value, 10);
        });

        brightnessInput.addEventListener('change', () => {
            brightness = parseInt(brightnessInput.value, 10) / 100;
        });

        colorPaletteInput.addEventListener('change', () => {
            colorPalette = colorPaletteInput.value;
            updatePalettePreview();
        });

        video.addEventListener('loadeddata', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            processVideo();
        });

        function processVideo() {
            video.play();
            video.addEventListener('play', () => {
                const process = () => {
                    if (!video.paused && !video.ended) {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        let frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        frame = pixelate(frame);
                        ctx.putImageData(frame, 0, 0);
                        requestAnimationFrame(process);
                    }
                };
                process();
            });
        }

        function pixelate(frame) {
            const width = frame.width;
            const height = frame.height;
            const data = frame.data;

            for (let y = 0; y < height; y += pixelSize) {
                for (let x = 0; x < width; x += pixelSize) {
                    const i = (y * width + x) * 4;
                    const avgR = data[i] * brightness;
                    const avgG = data[i + 1] * brightness;
                    const avgB = data[i + 2] * brightness;

                    const [closestR, closestG, closestB] = findClosestPaletteColor([avgR, avgG, avgB]);

                    for (let n = 0; n < pixelSize; n++) {
                        for (let m = 0; m < pixelSize; m++) {
                            if (x + m < width && y + n < height) {
                                const j = ((y + n) * width + (x + m)) * 4;
                                data[j] = closestR;
                                data[j + 1] = closestG;
                                data[j + 2] = closestB;
                            }
                        }
                    }
                }
            }

            return frame;
        }

        function findClosestPaletteColor(rgb) {
            const palette = palettes[colorPalette];
            let closestColor = palette[0];
            let minDistance = distance(rgb, palette[0]);

            for (let i = 1; i < palette.length; i++) {
                const color = palette[i];
                const dist = distance(rgb, color);
                if (dist < minDistance) {
                    minDistance = dist;
                    closestColor = color;
                }
            }

            return closestColor;
        }

        function distance(color1, color2) {
            const rDiff = color1[0] - color2[0];
            const gDiff = color1[1] - color2[1];
            const bDiff = color1[2] - color2[2];
            return rDiff * rDiff + gDiff * gDiff + bDiff * bDiff;
        }

        function updatePalettePreview() {
            const palette = palettes[colorPalette];
            palettePreview.innerHTML = '';
            palette.forEach(color => {
                const div = document.createElement('div');
                div.style.backgroundColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                palettePreview.appendChild(div);
            });
        }
        // Zobrazení výchozí palety při načtení stránky
        updatePalettePreview();
    </script>
</body>
</html>
